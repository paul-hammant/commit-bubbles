{
  "when": "2013-07-20T16:00:35-04:00", 
  "message": "Applying the patch for SYNAPSE-939 with some changes. Engaging the fail-safe mode when an invalid XML is encountered in the synapse configuration.", 
  "who": "hiranya", 
  "changes": [
    {
      "chunks": [
        {
          "locn": "-419,5 +419,11", 
          "lines": [
            "     public static final String FAIL_SAFE_MODE_SEQUENCES = \"sequences\";\n", 
            "     public static final String FAIL_SAFE_MODE_EVENT_SOURCE = \"eventsources\";\n", 
            "     public static final String FAIL_SAFE_MODE_EXECUTORS = \"executors\";\n", 
            "-    public static final String FAIL_SAFE_MODE_TEMPLATES = \"executors\";\n", 
            "+    public static final String FAIL_SAFE_MODE_TEMPLATES = \"templates\";\n", 
            "+    public static final String FAIL_SAFE_MODE_TASKS = \"tasks\";\n", 
            "+    public static final String FAIL_SAFE_MODE_MESSAGE_STORES = \"messagestores\";\n", 
            "+    public static final String FAIL_SAFE_MODE_MESSAGE_PROCESSORS = \"messageprocessors\";\n", 
            "+    public static final String FAIL_SAFE_MODE_APIS = \"apis\";\n", 
            "+    public static final String FAIL_SAFE_MODE_IMPORTS = \"imports\";\n", 
            "+\n", 
            " }\n"
          ]
        }
      ], 
      "to": "java/modules/core/src/main/java/org/apache/synapse/SynapseConstants.java", 
      "from": "java/modules/core/src/main/java/org/apache/synapse/SynapseConstants.java"
    }, 
    {
      "chunks": [
        {
          "locn": "-20,7 +20,6", 
          "lines": [
            " package org.apache.synapse.config.xml;\n", 
            " \n", 
            " import org.apache.axiom.om.OMElement;\n", 
            "-import org.apache.axiom.om.OMException;\n", 
            " import org.apache.axiom.om.OMXMLBuilderFactory;\n", 
            " import org.apache.commons.io.FileUtils;\n", 
            " import org.apache.commons.logging.Log;\n"
          ]
        }, 
        {
          "locn": "-135,7 +134,7", 
          "lines": [
            "         createMessageStores(synapseConfig, root, properties);\n", 
            "         createMessageProcessors(synapseConfig, root, properties);\n", 
            "         createSynapseImports(synapseConfig, root, properties);\n", 
            "-        createAPIs(synapseConfig, root, properties);\n", 
            "+        createAPIs(synapseConfig, root);\n", 
            " \n", 
            "         return synapseConfig;\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-198,15 +197,25", 
          "lines": [
            "             Iterator entryDefinitions = FileUtils.iterateFiles(localEntriesDir, extensions, false);\n", 
            "             while (entryDefinitions.hasNext()) {\n", 
            "                 File file = (File) entryDefinitions.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                Entry entry = SynapseXMLConfigurationFactory.defineEntry(synapseConfig, document,\n", 
            "-                        properties);\n", 
            "-                if (entry != null) {\n", 
            "-                    entry.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "-                            entry.getKey());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Local Entry from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_LOCALENTRIES, msg, e);\n", 
            "                 }\n", 
            "-             }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    Entry entry = SynapseXMLConfigurationFactory.defineEntry(synapseConfig, document,\n", 
            "+                                                                             properties);\n", 
            "+                    if (entry != null) {\n", 
            "+                        entry.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "+                                                                               entry.getKey());\n", 
            "+                    }\n", 
            "+                }\n", 
            "+            }\n", 
            "         }\n", 
            "     }\n", 
            " \n"
          ]
        }, 
        {
          "locn": "-222,15 +231,25", 
          "lines": [
            "             Iterator proxyDefinitions = FileUtils.iterateFiles(proxyServicesDir, extensions, false);\n", 
            "             while (proxyDefinitions.hasNext()) {\n", 
            "                 File file = (File) proxyDefinitions.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                ProxyService proxy = SynapseXMLConfigurationFactory.defineProxy(synapseConfig,\n", 
            "-                        document, properties);\n", 
            "-                if (proxy != null) {\n", 
            "-                    proxy.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                            file.getAbsolutePath(), proxy.getName());\n", 
            "-                 }\n", 
            "-             }\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Proxy service configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_PROXY_SERVICES, msg, e);\n", 
            "+                }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    ProxyService proxy = SynapseXMLConfigurationFactory.defineProxy(synapseConfig,\n", 
            "+                                                                                    document, properties);\n", 
            "+                    if (proxy != null) {\n", 
            "+                        proxy.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                                file.getAbsolutePath(), proxy.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "+            }\n", 
            "         }\n", 
            "     }\n", 
            " \n"
          ]
        }, 
        {
          "locn": "-246,12 +265,22", 
          "lines": [
            "             Iterator taskDefinitions = FileUtils.iterateFiles(tasksDir, extensions, false);\n", 
            "             while (taskDefinitions.hasNext()) {\n", 
            "                 File file = (File) taskDefinitions.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                Startup startup = SynapseXMLConfigurationFactory.defineStartup(synapseConfig,\n", 
            "-                        document, properties);\n", 
            "-                startup.setFileName(file.getName());\n", 
            "-                synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                        file.getAbsolutePath(), startup.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Task configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_TASKS, msg, e);\n", 
            "+                }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    Startup startup = SynapseXMLConfigurationFactory.defineStartup(synapseConfig,\n", 
            "+                                                                                   document, properties);\n", 
            "+                    startup.setFileName(file.getName());\n", 
            "+                    synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                            file.getAbsolutePath(), startup.getName());\n", 
            "+                }\n", 
            "              }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-268,15 +297,25", 
          "lines": [
            "             Iterator sequences = FileUtils.iterateFiles(sequencesDir, extensions, false);\n", 
            "             while (sequences.hasNext()) {\n", 
            "                 File file = (File) sequences.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                Mediator seq = SynapseXMLConfigurationFactory.defineSequence(synapseConfig,\n", 
            "-                        document, properties);\n", 
            "-                if (seq != null && seq instanceof SequenceMediator) {\n", 
            "-                    SequenceMediator sequence = (SequenceMediator) seq;\n", 
            "-                    sequence.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                            file.getAbsolutePath(), sequence.getName());\n", 
            "-                 }\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Sequence configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_SEQUENCES, msg, e);\n", 
            "+                }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    Mediator seq = SynapseXMLConfigurationFactory.defineSequence(synapseConfig,\n", 
            "+                                                                                 document, properties);\n", 
            "+                    if (seq != null && seq instanceof SequenceMediator) {\n", 
            "+                        SequenceMediator sequence = (SequenceMediator) seq;\n", 
            "+                        sequence.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                                file.getAbsolutePath(), sequence.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "              }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-292,31 +331,41", 
          "lines": [
            "             Iterator templates = FileUtils.iterateFiles(templatesDir, extensions, false);\n", 
            "             while (templates.hasNext()) {\n", 
            "                 File file = (File) templates.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                OMElement element = document.getFirstChildWithName(\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Template configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_TEMPLATES, msg, e);\n", 
            "+                }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    OMElement element = document.getFirstChildWithName(\n", 
            "                             new QName(SynapseConstants.SYNAPSE_NAMESPACE, \"sequence\"));\n", 
            "-                if (element != null) {\n", 
            "-                    TemplateMediator mediator =\n", 
            "-                            (TemplateMediator) SynapseXMLConfigurationFactory.defineMediatorTemplate(\n", 
            "-                                    synapseConfig, document, properties);\n", 
            "-                    if (mediator != null) {\n", 
            "-                        mediator.setFileName(file.getName());\n", 
            "-                        synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                                file.getAbsolutePath(), mediator.getName());\n", 
            "-                    }\n", 
            "-\n", 
            "-                } else {\n", 
            "-                    element = document.getFirstChildWithName(\n", 
            "-                            new QName(SynapseConstants.SYNAPSE_NAMESPACE, \"endpoint\"));\n", 
            "                     if (element != null) {\n", 
            "-                        Template endpointTemplate =\n", 
            "-                                SynapseXMLConfigurationFactory.defineEndpointTemplate(\n", 
            "+                        TemplateMediator mediator =\n", 
            "+                                (TemplateMediator) SynapseXMLConfigurationFactory.defineMediatorTemplate(\n", 
            "                                         synapseConfig, document, properties);\n", 
            "-                        if (endpointTemplate != null) {\n", 
            "-                            endpointTemplate.setFileName(file.getName());\n", 
            "+                        if (mediator != null) {\n", 
            "+                            mediator.setFileName(file.getName());\n", 
            "                             synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                                    file.getAbsolutePath(), endpointTemplate.getName());\n", 
            "+                                    file.getAbsolutePath(), mediator.getName());\n", 
            "                         }\n", 
            "+\n", 
            "+                    } else {\n", 
            "+                        element = document.getFirstChildWithName(\n", 
            "+                                new QName(SynapseConstants.SYNAPSE_NAMESPACE, \"endpoint\"));\n", 
            "+                        if (element != null) {\n", 
            "+                            Template endpointTemplate =\n", 
            "+                                    SynapseXMLConfigurationFactory.defineEndpointTemplate(\n", 
            "+                                            synapseConfig, document, properties);\n", 
            "+                            if (endpointTemplate != null) {\n", 
            "+                                endpointTemplate.setFileName(file.getName());\n", 
            "+                                synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                                        file.getAbsolutePath(), endpointTemplate.getName());\n", 
            "+                            }\n", 
            "+                        }\n", 
            "                     }\n", 
            "                 }\n", 
            "             }\n"
          ]
        }, 
        {
          "locn": "-335,14 +384,24", 
          "lines": [
            "             Iterator endpoints = FileUtils.iterateFiles(endpointsDir, extensions, false);\n", 
            "             while (endpoints.hasNext()) {\n", 
            "                 File file = (File) endpoints.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                Endpoint endpoint = SynapseXMLConfigurationFactory.defineEndpoint(\n", 
            "-                        synapseConfig, document, properties);\n", 
            "-                if (endpoint != null) {\n", 
            "-                    endpoint.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                            file.getAbsolutePath(), endpoint.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Endpoint configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_EP, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    Endpoint endpoint = SynapseXMLConfigurationFactory.defineEndpoint(\n", 
            "+                            synapseConfig, document, properties);\n", 
            "+                    if (endpoint != null) {\n", 
            "+                        endpoint.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                                file.getAbsolutePath(), endpoint.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-359,14 +418,24", 
          "lines": [
            "             Iterator events = FileUtils.iterateFiles(eventsDir, extensions, false);\n", 
            "             while (events.hasNext()) {\n", 
            "                 File file = (File) events.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                SynapseEventSource eventSource = SynapseXMLConfigurationFactory.\n", 
            "-                        defineEventSource(synapseConfig, document, properties);\n", 
            "-                if (eventSource != null) {\n", 
            "-                    eventSource.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                            file.getAbsolutePath(), eventSource.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Event Source configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_EVENT_SOURCE, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    SynapseEventSource eventSource = SynapseXMLConfigurationFactory.\n", 
            "+                            defineEventSource(synapseConfig, document, properties);\n", 
            "+                    if (eventSource != null) {\n", 
            "+                        eventSource.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                                file.getAbsolutePath(), eventSource.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-383,14 +452,24", 
          "lines": [
            "             Iterator executors = FileUtils.iterateFiles(executorsDir, extensions, false);\n", 
            "             while (executors.hasNext()) {\n", 
            "                 File file = (File) executors.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                PriorityExecutor executor = SynapseXMLConfigurationFactory.\n", 
            "-                        defineExecutor(synapseConfig, document, properties);\n", 
            "-                if (executor != null) {\n", 
            "-                    executor.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "-                            file.getAbsolutePath(), executor.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Executor configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_EXECUTORS, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    PriorityExecutor executor = SynapseXMLConfigurationFactory.\n", 
            "+                            defineExecutor(synapseConfig, document, properties);\n", 
            "+                    if (executor != null) {\n", 
            "+                        executor.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(\n", 
            "+                                file.getAbsolutePath(), executor.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-407,14 +486,24", 
          "lines": [
            "             Iterator messageStores = FileUtils.iterateFiles(messageStoresDir, extensions, false);\n", 
            "             while (messageStores.hasNext()) {\n", 
            "                 File file = (File) messageStores.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                MessageStore messageStore = SynapseXMLConfigurationFactory.defineMessageStore(\n", 
            "-                        synapseConfig, document, properties);\n", 
            "-                if (messageStore != null) {\n", 
            "-                    messageStore.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "-                            messageStore.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Message Store configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_MESSAGE_STORES, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    MessageStore messageStore = SynapseXMLConfigurationFactory.defineMessageStore(\n", 
            "+                            synapseConfig, document, properties);\n", 
            "+                    if (messageStore != null) {\n", 
            "+                        messageStore.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "+                                                                               messageStore.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-431,14 +520,24", 
          "lines": [
            "             Iterator messageProcessors = FileUtils.iterateFiles(messageProcessorDir, extensions, false);\n", 
            "             while (messageProcessors.hasNext()) {\n", 
            "                 File file = (File) messageProcessors.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                MessageProcessor messageProcessor = SynapseXMLConfigurationFactory.defineMessageProcessor(\n", 
            "-                        synapseConfig, document, properties);\n", 
            "-                if (messageProcessor != null) {\n", 
            "-                    messageProcessor.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "-                            messageProcessor.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Message Processor configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_MESSAGE_PROCESSORS, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    MessageProcessor messageProcessor = SynapseXMLConfigurationFactory.defineMessageProcessor(\n", 
            "+                            synapseConfig, document, properties);\n", 
            "+                    if (messageProcessor != null) {\n", 
            "+                        messageProcessor.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "+                                                                               messageProcessor.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-452,23 +551,31", 
          "lines": [
            "             Iterator synImports = FileUtils.iterateFiles(synImportsDir, extensions, false);\n", 
            "             while (synImports.hasNext()) {\n", 
            "                 File file = (File) synImports.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                SynapseImport synImp = SynapseXMLConfigurationFactory.defineImport(\n", 
            "-                        synapseConfig, document, properties);\n", 
            "-                if (synImp != null) {\n", 
            "-                    synImp.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "-                                                                           synImp.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building Synapse Import configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_IMPORTS, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    SynapseImport synImp = SynapseXMLConfigurationFactory.defineImport(\n", 
            "+                            synapseConfig, document, properties);\n", 
            "+                    if (synImp != null) {\n", 
            "+                        synImp.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "+                                                                               synImp.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            " \n", 
            "     }\n", 
            " \n", 
            "+    private static void createAPIs(SynapseConfiguration synapseConfig, String rootDirPath) {\n", 
            " \n", 
            "-    private static void createAPIs(SynapseConfiguration synapseConfig,\n", 
            "-                                            String rootDirPath, Properties properties) {\n", 
            "-\n", 
            "         File apiDir = new File(rootDirPath, REST_API_DIR);\n", 
            "         if (apiDir.exists()) {\n", 
            "             if (log.isDebugEnabled()) {\n"
          ]
        }, 
        {
          "locn": "-478,13 +585,23", 
          "lines": [
            "             Iterator apiIterator = FileUtils.iterateFiles(apiDir, extensions, false);\n", 
            "             while (apiIterator.hasNext()) {\n", 
            "                 File file = (File) apiIterator.next();\n", 
            "-                OMElement document = getOMElement(file);\n", 
            "-                API api = SynapseXMLConfigurationFactory.defineAPI(synapseConfig, document);\n", 
            "-                if (api != null) {\n", 
            "-                    api.setFileName(file.getName());\n", 
            "-                    synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "-                            api.getName());\n", 
            "+\n", 
            "+                OMElement document = null;\n", 
            "+                try {\n", 
            "+                    document = getOMElement(file);\n", 
            "+                } catch (Exception e) {\n", 
            "+                    String msg = \"Error while building API configuration from file : \" + file.getName();\n", 
            "+                    handleConfigurationError(SynapseConstants.FAIL_SAFE_MODE_APIS, msg, e);\n", 
            "                 }\n", 
            "+\n", 
            "+                if (document != null) {\n", 
            "+                    API api = SynapseXMLConfigurationFactory.defineAPI(synapseConfig, document);\n", 
            "+                    if (api != null) {\n", 
            "+                        api.setFileName(file.getName());\n", 
            "+                        synapseConfig.getArtifactDeploymentStore().addArtifact(file.getAbsolutePath(),\n", 
            "+                                                                               api.getName());\n", 
            "+                    }\n", 
            "+                }\n", 
            "             }\n", 
            "         }\n", 
            "     }\n"
          ]
        }, 
        {
          "locn": "-491,8 +608,6", 
          "lines": [
            " \n", 
            "     private static OMElement getOMElement(File file) {\n", 
            "         FileInputStream is;\n", 
            "-        OMElement document = null;\n", 
            "-\n", 
            "         try {\n", 
            "             is = FileUtils.openInputStream(file);\n", 
            "         } catch (IOException e) {\n"
          ]
        }, 
        {
          "locn": "-500,12 +615,10", 
          "lines": [
            "             return null;\n", 
            "         }\n", 
            " \n", 
            "+        OMElement document = OMXMLBuilderFactory.createOMBuilder(is).getDocumentElement();\n", 
            "+        document.build();\n", 
            "         try {\n", 
            "-            document = OMXMLBuilderFactory.createOMBuilder(is).getDocumentElement();\n", 
            "-            document.build();\n", 
            "             is.close();\n", 
            "-        } catch (OMException e) {\n", 
            "-            handleException(\"Error while parsing the content of the file: \" + file.getName(), e);\n", 
            "         } catch (IOException e) {\n", 
            "             log.warn(\"Error while closing the input stream from the file: \" + file.getName(), e);\n", 
            "         }\n"
          ]
        }, 
        {
          "locn": "-517,4 +630,13", 
          "lines": [
            "         log.error(msg, e);\n", 
            "         throw new SynapseException(msg, e);\n", 
            "     }\n", 
            "+\n", 
            "+    private static void handleConfigurationError(String componentType, String msg, Exception e) {\n", 
            "+        if (SynapseConfigUtils.isFailSafeEnabled(componentType)) {\n", 
            "+            log.warn(msg + \" - Continue in fail-safe mode\", e);\n", 
            "+        } else {\n", 
            "+            log.error(msg, e);\n", 
            "+            throw new SynapseException(msg, e);\n", 
            "+        }\n", 
            "+    }\n", 
            " }\n", 
            "\\ No newline at end of file\n"
          ]
        }
      ], 
      "to": "java/modules/core/src/main/java/org/apache/synapse/config/xml/MultiXMLConfigurationBuilder.java", 
      "from": "java/modules/core/src/main/java/org/apache/synapse/config/xml/MultiXMLConfigurationBuilder.java"
    }
  ], 
  "id": "1505194"
}